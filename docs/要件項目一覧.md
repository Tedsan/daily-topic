# 要件項目一覧

## 1. メタ情報

| 項目         | 値                   |
| ------------ | -------------------- |
| 作成日       | 2025‑07‑09           |
| 対象システム | Daily topic システム |
| バージョン   | 0.1                  |

## 2. 全体概要

- **目的**: SlackにRSSフィードされる投稿記事を、サマリーを生成してSlackに投稿する機能を実装する。
- **背景**: Slackに投稿される情報を整理し、重要なポイントを迅速に把握できるようにするため。

## 3. 要件一覧

### 3.1 機能要件 (Functional Requirements)

| ID     | 要件概要           | 詳細説明                                                                               | 優先度(P0/P1/P2) | 受入条件                                                                     | 参考・出典 |
| ------ | ------------------ | -------------------------------------------------------------------------------------- | ---------------- | ---------------------------------------------------------------------------- | ---------- |
| FR‑001 | RSS取得            | Slackチャネルの「#rss-feed」から過去24時間分のSlackメッセージからURLを抽出             | P0               | 想定件数±10% かつ 3 回リトライで取得成功                                     |            |
| FR‑002 | 本文抽出           | 各URLをfetchしMarkdown形式にする(タイトル／本文／メタ情報も残す。引用ブロックも残す。) | P0               | 抽出本文長 > 200 字                                                          |            |
| FR‑003 | サマリー生成       | claude code SDKで500文字以内の要約生成                                                 | P0               | categoryごとに要約をおこなう。LLM から category != "other" だけ通す          |            |
| FR‑004 | Slack投稿          | サマリーをSlackの「#daily-topic」チャネルにBlock Kitで投稿する                         | P0               | 投稿内容に(1)日付見出し (2)テーマ見出し (3)各要約 (4)元記事URLが含まれること |            |
| FR‑005 | スケジューラ       | 08:00 JSTに自動実行(cron)                                                              | P0               | Github Actionsのログに成功 exit 0                                            |            |
| FR‑006 | エラーハンドリング | 取得失敗時はSlackにエラーメッセージを投稿する                                          | P1               | ジョブID/失敗ステップ/スタックトレースを示したエラーメッセージを投稿         |            |

### 3.2 非機能要件 (Non‑Functional Requirements)

| ID      | カテゴリ     | 要件概要            | 詳細説明                       | 指標/目標値             | 優先度 | 受入条件 |
| ------- | ------------ | ------------------- | ------------------------------ | ----------------------- | ------ | -------- |
| NFR‑001 | 性能         | End-to-End 処理時間 |                                | ≦ 2 min/200 p95(アプリ) | P1     |          |
| NFR‑002 | 可用性       | システム稼働率      | 障害復旧は自動再実行する       | 99.9%                   | P1     |          |
| NFR‑003 | セキュリティ | API Key 暗号化      | 保存場所はGitHub Secretsに置く |                         | P0     |          |

### 3.3 データ要件

| ID     | データ種別 | 定義・仕様                                      | ソース     | 格納先                      |
| ------ | ---------- | ----------------------------------------------- | ---------- | --------------------------- |
| DR‑001 | 記事メタ   | article_url, title, published_at                | Slack JSON | in-memory (no persistence)  |
| DR‑002 | 要約ログ   | summary_id, generated_at, tokens_used, cost_usd | LLM API    | Slackメッセージの最後に添付 |

### 3.4 制約条件・前提

- **技術的制約**:
  - 使用するAPIは、claude code SDKを利用する。
  - Slack APIを使用してメッセージの投稿を行う。
  - RSSフィードは、Slackの「#rss-feed」チャネルから取得する。
  - 変更規模に応じて 0.2, 0.3… と上げる。（例：0.x = 草案, 1.0 = MVP リリース）。
  - **ランタイム／言語**: Python 3.12 / Poetry >= 1.8
  - **外部サービス**: Claude Code SDK >= 1.0、Slack Web API >= 2.0
  - **CI/CD**: GitHub Actions で Lint → Test → Deploy
- **法的/規制制約**:
  - 取得するRSSフィードのコンテンツは、著作権に抵触しないことを確認する。
- **運用上の前提**:
  - Daily topicシステムは、GitHub Actionsを使用して08:00 JSTに自動実行される。
  - Slackの「#daily-topic」チャネルは、適切な権限を持つユーザーのみが投稿できる。
- **自動テスト・モック方針**:

  1. **テストフレームワーク**
     - `pytest` + `pytest-cov` を使用し、`pytest --cov=src` で実行する。
  2. **ディレクトリ構成**

     ```text
     tests/
         unit/          # 関数レベルの純粋ユニットテスト
         integration/   # 外部 API のモックを含む I/F テスト
         e2e/           # GitHub Actions 上でのみ走らせるフルパイプライン
     ```

  3. **モックライブラリ**
     - HTTP呼び出し: responsesでClaude/Slack/外部サイトをスタブ化
     - 時刻固定：freezegunでJST 08:00を固定しタイムゾーン依存バグを防止
  4. カバレッジ基準
     - ユニットテスト: 80%以上
     - 統合テスト: 70%以上
     - E2Eテスト: 主要シナリオ網羅（全カテゴリ1件ずつ）
  5. 重複/副作用防止
     - 要約生成はmock_claude()フィクスチャで固定文字列を返し、トークン課金を回避。
     - Slack投稿はchat_postMessageをスタブし、payload.jsonをアサート。
  6. CI統合
     - name: testジョブでLint(ruff) → Unit + Integration → Coverageを実行。
     - 失敗時は、GitHub ChecksでPRをブロック。
  7. ローカル開発ドキュメント
     - 詳細手順はtests/README.mdに記載し、make testでワンコマンド実行を保証。

  備考: E2E テストは毎日 06:00 JST に GitHub Actions の Scheduled Workflow で回し、Claude/Slack 実 API への実送信可否を確認する。

- 要約記事カテゴリ

  | CatID | Label                    | 代表キーワード例                                                                       |
  | ----- | ------------------------ | -------------------------------------------------------------------------------------- |
  | C1    | Software-Defined Vehicle | SDV, AUTOSAR, Adaptive AUTOSAR, 車載ソフト                                             |
  | C2    | Industrial IoT & Edge    | Industrial IoT, IIoT, スマートファクトリー, Edge Computing                             |
  | C3    | Industrial Protocols     | MQTT, OPC UA, OPC UA FX, open62541, TSN, openPLC                                       |
  | C4    | Generative AI Tech       | Gemini CLI, Gemini 1.5, Claude 3, Claude Code, OpenAI, Anthropic, Mistral AI, DeepMind |
  | C5    | Gen-AI Use Cases         | 生成AI 活用事例, LLM ユースケース, RAG, AI agent, 導入事例, Case Study                 |
  | C6    | Other                    | 上記いずれにも当てはまらない場合                                                       |

### 3.5 依存関係

| ID      | 依存対象        | 依存内容                             | 影響範囲 |
| ------- | --------------- | ------------------------------------ | -------- |
| DEP‑001 | claude code SDK | バージョン1.0以上                    | FR‑003   |
| DEP‑002 | Slack API       | バージョン2.0以上                    | FR‑004   |
| DEP‑003 | RSSフィード     | Slackの「#rss-feed」チャネルから取得 | FR‑001   |
| DEP‑004 | GitHub Actions  | バージョン2.0以上                    | FR‑005   |

## 4. リスクと対応策

| ID      | リスク内容             | 影響 | 発生確率 | 対応策                                                         |
| ------- | ---------------------- | ---- | -------- | -------------------------------------------------------------- |
| RSK‑001 | APIの変更              | 中   | 低       | 最新のAPIドキュメントを参照し、定期的に更新する                |
| RSK‑002 | RSSフィードの形式変更  | 高   | 中       | フィードの形式を定期的に確認し、必要に応じてパーサーを更新する |
| RSK‑003 | サマリー生成の精度低下 | 高   | 中       | 定期的にサマリーの品質を評価し、必要に応じてモデルを最新化する |
| RSK‑004 | Slack APIの制限        | 中   | 低       | bulk 投稿時は 1 秒に 1 メッセージ以内                          |

## 5. 用語集

| 用語            | 定義                                                                                |
| --------------- | ----------------------------------------------------------------------------------- |
| RSS             | Really Simple Syndicationの略。ウェブサイトの更新情報を配信するためのフォーマット。 |
| Slack           | チームコミュニケーションツール。メッセージの送受やファイルの共有が可能。            |
| claude code SDK | AIによるコード生成や要約を行うためのソフトウェア開発キット。                        |
| GitHub Actions  | CI/CDツール。コードの自動ビルドやテスト、デプロイを行うための機能。                 |
| Block Kit       | Slackのメッセージを構築するためのUIフレームワーク。                                 |
| p95             | パーセンタイル95。データの95%がこの値以下であることを示す統計指標。                 |

## 6. 変更履歴

| 版  | 日付       | 変更概要 |
| --- | ---------- | -------- |
| 0.1 | 2025‑07‑09 | 初版     |
